#include <math.h>
#include <string.h>
#include <stdio.h>
#include "GPS.h"
#include "mcc_generated_files/mcc.h"

char data [80] = "";
//Methods
void divideStringByComma(char ArrayOfArrays[NUMBER_OF_STRINGS][NUMBER_OF_CHARACTERS])//method used to divide the information given by the GPS, so
//we can device which information to use
{
   int i = 0;
   char *token;
   char *rest = data;
   while ((token = strtok_r(rest, ",", &rest)))
   {
       strcat(ArrayOfArrays[i],token);
       i++;
   }
}

double getNMEACoordinates(char word[20], char multiplier[20])//Takes the information provided by the GPS and converts it into coordinates we can use
{
    //The NMEA code for the GPGGA returns, for the latitude and longitude, a number in the next format: (d)(d)(d)(m)(m).(m)(m)(m)(m)
    //This way, if the number is bigger than or equal to 100, it means that the numbers left to the (m) are degrees. The rest are minutes and
    //have to be divided by 60 and then added to the degrees
    char *endptr;
    double test= strtod(word,&endptr);
    double temporal = 0;
    if(test >= 100)
    {
        test=test/100;
        temporal = floor(test);
        temporal+= ((test - temporal)*100)/60;
    }
    else
    {
        temporal+= test/60;
    }
    if(strcmp(multiplier,"W")== 0 || strcmp(multiplier,"S")==0)//If the latitude and longitude are given in West or South, they must have a negative sign.
        temporal*=-1;
    return temporal;
}

void delay(int miliseconds)
{
    volatile int temp = 0;
    while(temp < miliseconds*81)//required to last 1.053 miliseconds
    {
        temp++;
    }
}

void initializeGPS()
{
commaCounter = 0;
positionCounter = 0;
uint8_t UBLOX_INIT[]= {//This array of information is necessary to configurate the GPS every time the microcontroller is turned on
  //Unnecessary if your GPS has a way to store its configuration even if its turned off
  // Disable NMEA
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x05,0x38, // GxGGA on
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x2B, // GxGLL on
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x02,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x32, // GxGSA off
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x03,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x39, // GxGSV off
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x04,0x00,0x00,0x00,0x00,0x00,0x01,0x04,0x40, // GxRMC off
  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x05,0x00,0x00,0x00,0x00,0x00,0x01,0x05,0x47, // GxVTG off

  // Disable UBX
  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x17,0xDC, //NAV-PVT off
  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x12,0xB9, //NAV-POSLLH off
  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0xC0, //NAV-STATUS off

  // Enable UBX
  //0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x07,0x00,0x01,0x00,0x00,0x00,0x00,0x18,0xE1, //NAV-PVT on
  //0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x13,0xBE, //NAV-POSLLH on
  //0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x03,0x00,0x01,0x00,0x00,0x00,0x00,0x14,0xC5, //NAV-STATUS on

  // Rate
  //0xB5,0x62,0x06,0x08,0x06,0x00,0x64,0x00,0x01,0x00,0x01,0x00,0x7A,0x12, //(10Hz) - 0.1 seconds
  //0xB5,0x62,0x06,0x08,0x06,0x00,0xC8,0x00,0x01,0x00,0x01,0x00,0xDE,0x6A, //(5Hz) - 0.2 seconds
  //0xB5,0x62,0x06,0x08,0x06,0x00,0xE8,0x03,0x01,0x00,0x01,0x00,0x01,0x39, //(1Hz) - 1 second
  0xB5,0x62,0x06,0x08,0x06,0x00,0x10,0x27,0x01,0x00,0x01,0x00,0x4D,0xDD,//0.1 hz - 10 seconds
  //0xB5,0x62,0x06,0x08,0x06,0x00,0x20,0x4E,0x01,0x00,0x01,0x00,0x84,0x00,//0.05 hz - 20 seconds
  //0xB5,0x62,0x06,0x08,0x06,0x00,0x30,0x75,0x01,0x00,0x01,0x00,0xBB,0x23,//0.03 hz - 30 seconds
};
int i = 0;
      for(i = 0; i < sizeof(UBLOX_INIT)/sizeof(UBLOX_INIT[0]); i++)
      {                        
    UART2_Write(UBLOX_INIT[i]);
    delay(5); // simulating a 38400baud pace (or less), otherwise commands are not accepted by the device.
      }
    latitude = 0;
    longitude = 0;
}

void GPS()//Method utilized to get the information from the GPS, and convert it. The UART2_Read method is to read from the UART, the provided code
{//is from the MCC configurator in MPLab
    temporal = UART2_Read();
            if(temporal == 0x2C)//Counts the number of commas
                commaCounter++;
            data[positionCounter++] = (char)temporal;//Adds each character to the string data
            if(commaCounter >= 14)
            {
                commaCounter = 0;
                positionCounter = 0;
                divideStringByComma(individual);
                latitude = getNMEACoordinates(individual[2],individual[3]);
                longitude = getNMEACoordinates(individual[4],individual[5]);
                /*printf("Latitude:%f\n",latitude);
                printf("Longitude:%f\n",longitude);*/
                int b = 0;
                memset(data,0,sizeof data);
                while(b<15)
               {
                   memset(individual[b],0,sizeof individual[b]);
                   b++;
               }     
            }
}